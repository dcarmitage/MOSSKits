# PunditKit Working Session - December 11, 2025

## Session Goal
Build out the market scanning and intelligence pipeline for PunditKit - an autonomous prediction market trading agent.

---

## Starting State

At session start, we had:
- Basic Pundit HQ portal with dashboard, markets, research, evaluations, trades views
- CDP-based market scanning via Playwriter (browser automation)
- Research via Gemini API (queued through Cloudflare)
- Evaluation via Claude API
- D1 database for persistence
- Manual trade logging

**Key Problem:** The market scanning was unreliable - it was scraping Polymarket's DOM and extracting wrong data.

---

## Iteration 1: URL Extraction Fix

### Problem
When clicking market links in Pundit HQ, they weren't going to the correct Polymarket pages.

### Root Cause
URL extraction was only getting the last segment of the path:
- Actual: `/event/who-will-trump-talk-to-in-december/will-trump-talk-to-narendra-modi-in-december`
- Extracted: just `will-trump-talk-to-narendra-modi-in-december`
- Constructed: `/event/will-trump-talk-to-narendra-modi-in-december` (wrong!)

### Fix
- Keep the full href path from Polymarket links
- Store complete URL in database
- Update all places that construct URLs to use `market.url` with fallback to `external_id`

### Files Changed
- `demo/portal/src/App.tsx` - URL extraction, all link references
- `demo/agent/src/index.ts` - Accept and store URL in scan endpoint
- `demo/agent/schema.sql` - Added `url` column

### Database Migration
```sql
ALTER TABLE markets ADD COLUMN url TEXT;
ALTER TABLE markets ADD COLUMN description TEXT;
ALTER TABLE markets ADD COLUMN resolution_criteria TEXT;
```

---

## Iteration 2: Market Question Extraction - First Attempt

### Problem
Scan was pulling in individual candidate names (like "Emily White", "AndrÃ© Maestrini") instead of the actual market question ("Next CEO of Lululemon?").

### Root Cause
The CSS selector `a[href*="/event/"]` was too broad - it matched individual option links within multi-choice markets, not the market card itself.

### First Fix Attempt
- Changed selector strategy to walk up DOM tree to find card container
- Added filters to skip date patterns, percentages, names
- Used `seenQuestions` Set for deduplication

### Result
Better, but still extracting dates like "January 31, 2026" instead of "Will New Glenn Flight 3 launch by...?"

---

## Iteration 3: Market Question Extraction - Second Attempt

### Problem
Still grabbing individual outcomes (dates) instead of parent market questions.

### Root Cause Analysis
Polymarket URL structure:
- Parent event: `/event/will-new-glenn-flight-3-launch-by`
- Individual outcomes: `/event/will-new-glenn-flight-3-launch-by/january-31-2026`

The scanner was processing ALL links including outcome-specific ones. When walking up the DOM from an outcome link, it found the outcome container, not the parent market card.

### Second Fix Attempt
- Group by parent slug (extract `parts[1]` from URL)
- Prioritize text ending with `?`
- Skip lines starting with month names
- Use Map keyed by parent slug for deduplication

### Result
Still inconsistent - the fundamental approach of DOM scraping was too fragile.

---

## Iteration 4: Architecture Pivot - Gamma API

### Key Insight
User approved switching from DOM scraping to Polymarket's official Gamma API after repeated scraping failures.

### Discovery
Polymarket has a free, public API:
```
GET https://gamma-api.polymarket.com/markets?active=true&closed=false&limit=100
```

Returns structured data:
```json
{
  "id": "516710",
  "question": "US recession in 2025?",
  "conditionId": "0xfa48a99...",
  "slug": "us-recession-in-2025",
  "description": "Market resolution criteria...",
  "endDate": "2026-02-28T12:00:00Z",
  "outcomes": ["Yes", "No"],
  "outcomePrices": ["0.0115", "0.9885"],
  "volume": "10669675.627662",
  "liquidity": "90831.35553",
  "active": true,
  "closed": false
}
```

### Key Gotchas Discovered
- `outcomePrices` is array of **strings**, not numbers
- `volume` and `liquidity` are **strings**, need `parseFloat()`
- `conditionId` is the unique identifier (hex string)
- `slug` is used for URL construction

---

## Iteration 5: Initial Gamma API Implementation

### Changes
1. Added `syncMarkets()` function to portal that fetches from Gamma API
2. Added `/markets/sync` endpoint to Worker
3. Replaced "Scan Markets" button with "Sync Markets"
4. Removed old CDP scanning code

### Files Changed
- `demo/portal/src/App.tsx` - New syncMarkets function, updated UI
- `demo/agent/src/index.ts` - New /markets/sync endpoint

### Problem Encountered
**CORS Error!**
```
Access to fetch at 'https://gamma-api.polymarket.com/...' from origin 'https://pundit-hq.pages.dev' has been blocked by CORS policy
```

Browser can't directly call Gamma API due to CORS restrictions.

---

## Iteration 6: CORS Fix - Worker Proxy

### Solution
Move Gamma API fetch to the Worker (server-side, no CORS restrictions).

### Architecture
```
Portal (browser)
    â†’ POST /markets/sync-from-gamma
    â†’ Worker (fetches from Gamma API)
    â†’ D1 Database
```

### Changes
1. Added `/markets/sync-from-gamma` endpoint to Worker
   - Worker fetches from Gamma API directly
   - Transforms and stores data
   - Returns success/failure to Portal
2. Updated Portal to call Worker endpoint instead of Gamma API

### Files Changed
- `demo/agent/src/index.ts` - New proxy endpoint
- `demo/portal/src/App.tsx` - Call Worker instead of Gamma API

### Result
âœ… **Working!** Markets now sync reliably from Polymarket's official API.

---

## Final Architecture (Post-Session)

### Market Sync Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Portal: Click "Sync Markets"                                    â”‚
â”‚ POST /markets/sync-from-gamma                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker: Fetch from Gamma API                                    â”‚
â”‚ https://gamma-api.polymarket.com/markets?active=true&...        â”‚
â”‚ Transform data, upsert to D1                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ D1 Database: markets table                                      â”‚
â”‚ id, platform, external_id, url, question, description,          â”‚
â”‚ current_odds_yes, current_odds_no, volume, liquidity,           â”‚
â”‚ close_date, status, created_at, updated_at                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Planned Pipeline (From Plan File)
```
Phase 1: Market Sync (Gamma API)           âœ… COMPLETE
Phase 2: Parallel Research (Cloudflare Queue)  - Existing, needs batch trigger
Phase 3: Batch Evaluation (Claude API)         - Needs batch endpoint
Phase 4: Comment Sentiment (CDP Browser)       - Planned
Phase 5: Re-evaluation with Sentiment          - Planned
Phase 6: Trade Opportunities UI                - Existing, needs enhancement
```

---

## Lessons Learned

### 1. API-First Over Scraping
DOM scraping is fragile. When an official API exists, use it. The Gamma API provides:
- Structured, typed data
- Reliable field names
- No CSS selector dependencies
- Volume, liquidity, description - data not easily scraped

### 2. CORS Requires Server Proxy
Browser-side fetches to third-party APIs will hit CORS. Solution:
- Cloudflare Worker acts as proxy
- Worker fetches from external API
- Portal calls Worker endpoint

### 3. Data Types Matter
Gamma API returns strings for numbers:
```javascript
// Wrong
const odds = m.outcomePrices[0]; // "0.65" (string!)

// Right
const odds = parseFloat(m.outcomePrices[0]); // 0.65 (number)
```

### 4. URL Structure Understanding
Polymarket uses nested URLs:
- `/event/{parent-slug}` - Event overview page
- `/event/{parent-slug}/{outcome-slug}` - Specific outcome

For linking, use the parent slug or store the full URL.

### 5. Incremental Iteration
Each fix revealed the next issue:
1. Wrong URLs â†’ Fix URL extraction
2. Wrong questions â†’ Fix DOM traversal
3. Still wrong â†’ Fix parent/child grouping
4. Still fragile â†’ Switch to API
5. CORS error â†’ Add Worker proxy

---

## Code Patterns Established

### Worker Endpoint Pattern
```typescript
app.post('/markets/sync-from-gamma', async (c) => {
  try {
    // 1. Fetch from external API
    const response = await fetch('https://external-api.com/...');
    const data = await response.json();

    // 2. Log start
    await logJournalEntry(c.env.DB, 'scout', 'sync_started', {...});

    // 3. Process and upsert
    for (const item of data) {
      const existing = await c.env.DB.prepare('SELECT...').first();
      if (existing) {
        await c.env.DB.prepare('UPDATE...').run();
      } else {
        await c.env.DB.prepare('INSERT...').run();
      }
    }

    // 4. Log completion
    await logJournalEntry(c.env.DB, 'scout', 'sync_completed', {...});

    // 5. Return result
    return c.json({ success: true, created, updated });
  } catch (err) {
    return c.json({ error: '...' }, 500);
  }
});
```

### Portal Action Pattern
```typescript
const syncMarkets = async () => {
  setIsLoading(true);
  setError(null);

  try {
    const response = await fetch(`${API_URL}/endpoint`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error || 'Failed');
    }

    const result = await response.json();
    console.log('Result:', result);

    await fetchData(); // Refresh UI
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Failed');
  } finally {
    setIsLoading(false);
  }
};
```

---

## Files Modified This Session

| File | Changes |
|------|---------|
| `demo/portal/src/App.tsx` | Removed scanMarkets, added syncMarkets, updated DashboardView props, UI text updates |
| `demo/agent/src/index.ts` | Added /markets/sync-from-gamma, /markets/sync endpoints |
| `demo/agent/schema.sql` | Added url, description, resolution_criteria columns |

---

## Deployed Endpoints

- **Portal**: https://pundit-hq.pages.dev
- **Worker**: https://pundit-agent.gentle-disk-2e8a.workers.dev

---

## Next Steps for PunditKit v1.1

Based on this session, the spec should include:

1. **Use Gamma API from the start** - No DOM scraping for market discovery
2. **Worker-side external API calls** - Avoid CORS issues
3. **Batch operations** - Research All, Evaluate All buttons
4. **Comment sentiment phase** - CDP automation for top candidates only
5. **Proper data types** - Document that Gamma API returns strings for numbers
6. **Complete URL handling** - Store full URLs, not just slugs

### Recommended Spec Additions

```markdown
## Market Data Source

Use Polymarket's Gamma API for market discovery:
- Endpoint: `https://gamma-api.polymarket.com/markets`
- No authentication required
- Returns structured JSON with question, odds, volume, liquidity

**Important**: Fetch from Worker (server-side) to avoid CORS restrictions.

## Data Type Handling

Gamma API returns numeric values as strings:
- `outcomePrices`: `["0.65", "0.35"]` - parse with `parseFloat()`
- `volume`: `"10669675.627662"` - parse with `parseFloat()`
- `liquidity`: `"90831.35553"` - parse with `parseFloat()`
```

---

## Session Stats (Morning)

- **Duration**: ~3 hours
- **Iterations**: 6 major pivots
- **Deployments**: 8+
- **Key Breakthrough**: Switching from DOM scraping to Gamma API

---

## Session 2: Phoenix Rebuild (Evening)

### Problem Statement
Markets syncing from Gamma API, but the UI doesn't show enough information to evaluate trades. Need to "recreate the Polymarket interface" - show market images, all outcomes with prices, resolution criteria, price trends, etc.

### Decision: Phoenix Mode
User approved wiping all tables (except settings) and rebuilding from scratch with enhanced schema.

---

## Iteration 7: Schema & Data Model Overhaul

### New `events` Table
Polymarket groups related markets under parent events (e.g., "SpaceX Launches 2025" contains "4-6 launches", "7-9 launches", etc.).

```sql
CREATE TABLE IF NOT EXISTS events (
  id TEXT PRIMARY KEY,
  slug TEXT NOT NULL UNIQUE,
  title TEXT NOT NULL,
  image TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
```

### Enhanced `markets` Table
Key changes:
- Multi-outcome support via JSON arrays (`outcomes`, `outcome_prices`)
- Added `event_id` foreign key for grouping
- Added `image`, `description` for rich display
- Added `volume_24hr`, `one_day_price_change`, `one_week_price_change`, `competitive`
- Removed old `current_odds_yes/no` columns

```sql
outcomes TEXT NOT NULL DEFAULT '["Yes", "No"]',      -- JSON array
outcome_prices TEXT NOT NULL DEFAULT '["0.5", "0.5"]', -- JSON array
```

### Migration Executed
```bash
npx wrangler d1 execute pundit-db --file=./phoenix-migrate.sql --remote
npx wrangler d1 execute pundit-db --file=./schema.sql --remote
```

---

## Iteration 8: Worker Updates

### Enhanced `/markets/sync-from-gamma`
Now captures full Gamma API data:

1. **Upserts events first** from `m.events[0]`
2. **Stores multi-outcome data** as JSON strings
3. **Captures price trends** (`oneDayPriceChange`, `oneWeekPriceChange`)
4. **Stores images** for both markets and events

### New Endpoints
- `GET /events` - List all events with market counts
- `GET /events/:id` - Get event with all its markets

### Sync Results
After deployment: 40 events created, 100 markets synced with full data.

---

## Iteration 9: Portal UI Overhaul

### New Components Created

**MarketCard** - Rich card showing:
- Market thumbnail image
- Question as clickable link to Polymarket
- All outcomes with visual price bars
- Metadata: end date, volume, 24hr volume
- Price trend badges (green/red for 1d/1w change)
- Resolution criteria (collapsible)
- Research/Evaluate action buttons

**BinaryOutcomeBar** - For Yes/No markets:
```
YES â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 65%
NO  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 35%
```

**MultiOutcomeBar** - For multi-outcome markets:
```
7-9 launches  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 35%
10-12         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 30%
4-6           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%
```

### Multi-View Sorting
Added sort/view controls:
- **Sort modes**: Volume, Activity, Ending Soon, Competitive
- **View modes**: Flat list, Grouped by Event
- Preferences persist to localStorage

### Code Cleanup
- Removed legacy `deepScanMarkets` function (no longer needed)
- Updated all references from `current_odds_yes/no` to `outcome_prices` JSON
- Fixed all URL construction to use `slug` properly

---

## Files Modified This Session (Evening)

| File | Changes |
|------|---------|
| `demo/agent/schema.sql` | Complete rewrite - added events table, enhanced markets with multi-outcome support |
| `demo/agent/phoenix-migrate.sql` | New file - drops all tables for rebuild |
| `demo/agent/src/types.ts` | Added Event, updated Market, added GammaMarket interface |
| `demo/agent/src/index.ts` | Rewrote sync endpoint, added /events endpoints |
| `demo/portal/src/App.tsx` | Updated Market interface, added MarketCard/OutcomeBar components, multi-view sorting |

---

## Key Design Decisions

1. **JSON arrays for outcomes** - Store as JSON strings, parse in UI. Simpler than junction tables.
2. **Events as first-class entities** - Enables grouping related markets together
3. **Keep UI in single file** - Will refactor to components once design stabilizes
4. **Remove deepScan** - Gamma API provides description/resolution directly, no need for CDP scraping

---

## Deployed State

- **Portal**: https://pundit-hq.pages.dev (rich market cards, multi-view)
- **Worker**: https://pundit-agent.gentle-disk-2e8a.workers.dev (full Gamma data sync)
- **Database**: Phoenix rebuilt with events + enhanced markets

---

## Session Stats (Evening)

- **Duration**: ~2 hours
- **Key Changes**: Schema rebuild, UI overhaul
- **Deployments**: Worker + Portal
- **Result**: Markets now display like Polymarket - images, all outcomes, price trends, descriptions

---

## Iteration 10: Plan Completion & Polish

### Review of Plan vs Implementation
Checked the plan file and identified gaps:

1. **Dashboard Multi-View** - Plan mentioned Dashboard should have sort capability
2. **Edge Sort Mode** - Plan mentioned sorting by "Best Edge" (requires evaluation data)
3. **PriceTrend component** - Already implemented inline in MarketCard âœ…
4. **ResolutionCriteria** - Already implemented as collapsible section âœ…

### Changes Made

**Dashboard Enhancements:**
- Replaced simple "Active Markets" list with rich "Top Markets" section
- Added sort dropdown: By Volume, 24h Activity, Ending Soon, Competitive
- Added "Pipeline Status" card showing counts by status (Watching, Researching, Traded, Ready to Trade)
- Market cards now include images, price trends, and link to Polymarket

**Edge Sort Mode:**
- Added `edge` to SortMode type
- MarketsView now accepts `evaluations` prop
- Created `marketEdgeMap` to lookup best edge per market
- Markets with evaluations sort first by composite_edge
- Added "Best Edge" option to sort dropdown

### Files Modified
- `demo/portal/src/App.tsx` - Dashboard redesign, edge sort implementation

### Final Deployment
Portal deployed to https://pundit-hq.pages.dev

---

## Plan Checklist - Final Status

| Step | Status |
|------|--------|
| Schema with events table | âœ… Complete |
| Enhanced markets table with outcomes arrays | âœ… Complete |
| Phoenix migration on D1 | âœ… Complete |
| Worker types (Event, Market, GammaMarket) | âœ… Complete |
| Sync-from-gamma captures full Gamma data | âœ… Complete |
| /events endpoints | âœ… Complete |
| Portal Market/Event interfaces | âœ… Complete |
| MarketCard with image + outcomes | âœ… Complete |
| BinaryOutcomeBar / MultiOutcomeBar | âœ… Complete |
| PriceTrend indicator | âœ… Complete (inline) |
| ResolutionCriteria collapsible | âœ… Complete |
| Sort modes (volume/activity/ending_soon/competitive/edge) | âœ… Complete |
| View mode toggle (flat/grouped) | âœ… Complete |
| LocalStorage persistence | âœ… Complete |
| Dashboard multi-view | âœ… Complete |

**All planned items implemented.**

---

## Session 3: Kanban Pipeline Redesign

### User Vision
Transform the Markets page from a flat list with filters into a **Kanban-style workflow** where markets flow through stages:

```
Watching â†’ Researching â†’ Evaluated â†’ Traded
```

Key insight: The old UI had separate views for Markets, Research, and Evaluations. But these are stages of a single pipeline, not separate concerns.

---

## Iteration 11: Kanban Pipeline Implementation

### Architecture Changes

**Before (separate views):**
- Markets view with status filter tabs
- Research view (separate page)
- Evaluations view (separate page)
- Trades view (separate page)

**After (unified pipeline):**
- Markets Pipeline with workflow tabs
- Cards flow through tabs as actions are taken
- Trade History remains separate (for P&L tracking)

### Workflow Tab Logic

| Tab | Filter | Description |
|-----|--------|-------------|
| **Watching** | `status === 'watching' && !hasEvaluation` | Fresh synced markets |
| **Researching** | `status === 'researching' && !hasEvaluation` | Research in progress/done |
| **Evaluated** | `hasEvaluation(market.id) && status !== 'traded'` | Has evaluation, ready to trade |
| **Traded** | `status === 'traded'` | Trade executed |

### MarketCard Variants by Tab

**Watching Tab:**
```tsx
<button>Research</button>           // Triggers research only
<button>Research + Evaluate</button> // Triggers both
```

**Researching Tab:**
```tsx
<span>Research: {status}</span>     // running/completed/failed
<button disabled={!complete}>Evaluate</button>
```

**Evaluated Tab (Polymarket-style trade UI):**
```tsx
<div className="trade-recommendation">
  <span className="direction">YES</span>
  <span>$50 at 65%</span>
  <span className="edge">+12.5% edge</span>
</div>
<button>Trade on Polymarket</button>
<button>Confirm Trade</button>
// Collapsible: Evaluation Details (scores, reasoning)
```

**Traded Tab:**
```tsx
<span>Trade executed</span>
<a>View on Polymarket</a>
```

### Sidebar Simplification

**Removed:**
- Research sidebar button
- Evaluations sidebar button

**Kept:**
- Dashboard
- Markets (now "Pipeline")
- Trade History
- Journal

**Renamed:**
- "Markets" section â†’ "Pipeline" section
- "Watching" button â†’ "Markets" button

### Key Technical Details

**Evaluation status is derived, not stored:**
```typescript
const hasEvaluation = (marketId: string) =>
  evaluations.some(e => e.market_id === marketId);
```

**Research status lookup:**
```typescript
const getResearchStatus = (marketId: string) => {
  const paths = researchPaths.filter(p => p.market_id === marketId);
  if (paths.some(p => p.status === 'running')) return 'running';
  if (paths.some(p => p.status === 'completed')) return 'completed';
  return 'failed';
};
```

**No API changes needed:**
The existing `/research/spawn` endpoint already updates market status to 'researching' and accepts `auto_evaluate: boolean` flag.

### Files Modified

| File | Changes |
|------|---------|
| `demo/portal/src/App.tsx` | WorkflowTab type, Kanban tabs UI, MarketCard variants, sidebar cleanup |

### Visual Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WATCHING   â”‚ â”€â”€â–º â”‚ RESEARCHING â”‚ â”€â”€â–º â”‚  EVALUATED  â”‚ â”€â”€â–º â”‚   TRADED    â”‚
â”‚             â”‚     â”‚             â”‚     â”‚             â”‚     â”‚             â”‚
â”‚ [Research]  â”‚     â”‚ In progress â”‚     â”‚ YES $50 @65%â”‚     â”‚ Entry: 65%  â”‚
â”‚ [Evaluate]  â”‚     â”‚ [Evaluate]  â”‚     â”‚ +12% edge   â”‚     â”‚ Current:72% â”‚
â”‚             â”‚     â”‚             â”‚     â”‚ [Trade â–¸]   â”‚     â”‚ P&L: +$18   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Session 3 Stats

- **Duration**: ~1 hour
- **Key Insight**: Markets, Research, Evaluations are pipeline stages, not separate views
- **Deployment**: https://pundit-hq.pages.dev
- **Result**: Unified Kanban workflow with Polymarket-style trade UI

---

## End of Day Summary

### Three Major Iterations Today

1. **Morning: Gamma API Migration**
   - Ditched flaky DOM scraping
   - Switched to Polymarket's official Gamma API
   - Added Worker proxy to avoid CORS

2. **Evening: Phoenix Rebuild**
   - Wiped database, rebuilt schema
   - Added events table for market grouping
   - Multi-outcome support via JSON arrays
   - Rich MarketCard UI with images, price trends

3. **Night: Kanban Pipeline**
   - Transformed Markets page into workflow tabs
   - Consolidated Research/Evaluations views into pipeline
   - Polymarket-style trade UI in Evaluated tab
   - Simplified sidebar navigation

### Deployed State

- **Portal**: https://pundit-hq.pages.dev
- **Worker**: https://pundit-agent.gentle-disk-2e8a.workers.dev
- **Features**:
  - Gamma API sync (100 markets)
  - 4-stage Kanban pipeline (Watching â†’ Researching â†’ Evaluated â†’ Traded)
  - Rich market cards with images, outcomes, price trends
  - Inline trade UI with evaluation details
  - Sort by volume, activity, ending soon, competitive, edge

---

# December 12, 2025 - Intelligence Upgrade

## Session 4: Deep Research Robustness

### Problem Statement
Deep Research Pro was fragile - if the Worker crashed during polling, we couldn't resume. The Gemini Interactions API returns an `interaction_id` that should be saved immediately, but we were only saving it after completion.

### Root Cause Analysis
```
Current flow (bad):
1. Queue triggers createDeepResearch()
2. Polls for 2-10 minutes
3. On completion, saves interaction_id
4. Problem: Worker crash = lost research, have to restart

Desired flow (good):
1. Queue triggers createDeepResearch()
2. Save interaction_id to DB immediately
3. Poll with progress updates
4. On crash/retry, check for existing interaction_id
5. Resume polling from where we left off
```

### Implementation

**Split `researcher.ts` into create + poll:**
```typescript
export interface DeepResearchInteraction {
  interactionId: string;
  initialStatus: string;
}

// Step 1: Create interaction, return ID immediately
export async function createDeepResearchInteraction(
  geminiApiKey: string,
  query: string
): Promise<DeepResearchInteraction> {
  // POST to Gemini Interactions API
  // Returns interaction ID within ~1 second
}

// Step 2: Poll until done, with progress callback
export async function pollDeepResearchUntilComplete(
  geminiApiKey: string,
  interactionId: string,
  onProgress?: PollProgressCallback
): Promise<GeminiResearchResult> {
  // GET interaction status every 10 seconds
  // Call onProgress after each poll
  // Return when status === 'completed'
}
```

**Queue consumer with resume capability:**
```typescript
// Check for existing interaction_id (resume case)
if (!interactionId) {
  const interaction = await createDeepResearchInteraction(apiKey, query);
  interactionId = interaction.interactionId;
  // Save immediately for resumability
  await env.DB.prepare(`
    UPDATE research_paths SET gemini_interaction_id = ? WHERE id = ?
  `).bind(interactionId, researchPathId).run();
}

// Progress callback updates DB during polling
const onProgress = async (pollCount: number) => {
  await env.DB.prepare(`
    UPDATE research_paths SET poll_count = ?, last_polled_at = datetime('now') WHERE id = ?
  `).bind(pollCount, researchPathId).run();
};
```

**New columns in research_paths:**
```sql
ALTER TABLE research_paths ADD COLUMN poll_count INTEGER DEFAULT 0;
ALTER TABLE research_paths ADD COLUMN last_polled_at TEXT;
ALTER TABLE research_paths ADD COLUMN started_at TEXT;
```

### Result
- Research survives Worker crashes
- Queue retry = resume polling from existing interaction
- Progress tracking in DB for visibility

---

## Session 5: Frontend Progress Visibility

### Problem
1. Elapsed time counter only updated every 5 seconds (on poll)
2. Showing "Poll 1, Poll 2, Poll 3" to users - developer noise

### Fixes

**Live 1-second counter:**
```typescript
function ResearchReportRow({ research }) {
  const [elapsed, setElapsed] = useState(0);

  useEffect(() => {
    if (!isRunning) return;
    const startTime = research.started_at || research.created_at;
    const startDate = new Date(startTime + 'Z');
    const updateElapsed = () => setElapsed(Math.floor((Date.now() - startDate.getTime()) / 1000));
    updateElapsed();
    const interval = setInterval(updateElapsed, 1000);
    return () => clearInterval(interval);
  }, [isRunning, research.started_at, research.created_at]);

  return <span>Running {formatDuration(elapsed)}...</span>;
}
```

**Removed poll count display** - users don't need to see internal polling mechanics.

---

## Session 6: Parallel Research Fix

### Problem
Second research report queued instead of running in parallel.

### Root Cause
Cloudflare Queue default `max_concurrency = 1`.

### Fix
```toml
# wrangler.toml
[[queues.consumers]]
queue = "pundit-research"
max_batch_size = 10
max_concurrency = 10  # <-- Added this
max_retries = 3
```

### Result
Multiple Deep Research Pro reports can run simultaneously.

---

## Session 7: Evaluation Bug Fixes

### Bug 1: 495% Edge Display

**Screenshot showed:** Market at 0% YES recommending "BUY YES" with "+495% edge"

**Root cause:** Edge was being double-multiplied by 100
```typescript
// In evaluator.ts
return (estimatedProbability - marketOdds) * 100;  // Returns 5 for 5% edge

// In frontend
{(evaluation.composite_edge * 100).toFixed(1)}%  // 5 * 100 = 500%
```

**Fix:** Return decimal from `calculateEdge()`:
```typescript
export function calculateEdge(
  estimatedProbability: number,
  marketOdds: number
): number {
  return estimatedProbability - marketOdds;  // Returns 0.05 for 5% edge
}
```

### Bug 2: Floor Probability Trading

**Problem:** System recommending BUY YES when:
- Market at 0-3% YES
- Model outputs 5% (calibration floor)
- System sees +2-5% "edge" and recommends trade

**Root cause:** The 5% probability floor exists for calibration (never output < 5%), not as a real estimate. When market is below the floor, there's no meaningful signal.

**Fix:**
```typescript
const isAtFloor = richEvaluation.probability <= 0.06;
const isAtCeiling = richEvaluation.probability >= 0.94;
const marketBelowFloor = currentOdds < 0.04;
const marketAboveCeiling = currentOdds > 0.96;

const isFloorCeilingCase = (isAtFloor && marketBelowFloor) || (isAtCeiling && marketAboveCeiling);
const recommendedPosition = isFloorCeilingCase ? 0 : calculateKellyPosition(...);
```

### Bug 3: Duration Wrong After Resume

**Problem:** Research showing "Running 19s" then completing in "16s"

**Root cause:** Duration calculated from queue consumer start time, not actual research start time.

**Fix:** Store `started_at` in DB, read from DB for duration calculation:
```typescript
const startTime = research.started_at || research.created_at;
const startDate = new Date(startTime + 'Z');
const elapsed = Math.floor((Date.now() - startDate.getTime()) / 1000);
```

---

## Session 8: Alpha-Seeking Evaluation Philosophy

### The Fundamental Problem

**User feedback:** "The evaluation system is fundamentally flawed. You're recommending I buy YES things at 3% just because you have a 2% estimated margin. This is terrible because if we lose, we lose all our money. We should only be doing trades when we have a non-consensus view - when we think we are smarter than the crowds."

### Key Insight

The old system operated mechanically:
```
IF estimated_prob > market_odds + threshold THEN recommend_trade
```

This is wrong because:
1. **Markets are usually right** - the price reflects collective wisdom
2. **Small edge = high risk** - buying at 3% means 97% chance of losing everything
3. **No alpha identification** - the system never asked "why would I know better?"

### New Philosophy: Alpha-Seeking

```
DEFAULT: NO TRADE

Only trade when:
1. We have SPECIFIC information the market hasn't priced in
2. We can ARTICULATE why the market is wrong
3. We have GENUINE ALPHA (not just a different number)
```

### New Prompt Design

**System Prompt (key sections):**
```
CORE PRINCIPLE: The market is usually right. The current price reflects the collective
wisdom of thousands of participants with real money at stake. You should ONLY recommend
trading when you have a SPECIFIC, ARTICULABLE reason to believe the market is wrong.

DEFAULT STANCE: NO TRADE. You must be convinced TO trade, not convinced NOT to trade.

WHAT COUNTS AS ALPHA:
- Information the market hasn't priced in yet (breaking news, obscure sources)
- Analysis that reveals a flaw in consensus thinking
- Expertise that lets you interpret information better than the crowd
- Timing advantages (you know something before it's widely known)

WHAT DOES NOT COUNT AS ALPHA:
- Your probability estimate being slightly different from the market
- "I think X is more/less likely" without specific evidence
- Disagreeing with the market just because your model outputs a different number
- Gut feelings or vague intuitions

RISK AWARENESS:
- Buying YES at 3% means losing 100% of stake if wrong
- Markets near extremes (0-10% or 90-100%) require EXTRAORDINARY evidence
```

**New JSON Output Structure:**
```json
{
  "probability": 0.25,
  "confidence": "medium",
  "recommend_trade": false,
  "trade_direction": null,
  "information_advantage": "weak",
  "market_inefficiency": null,
  "trade_thesis": null,
  "base_rate": {...},
  "key_factors_yes": [...],
  "key_factors_no": [...],
  "main_uncertainty": "...",
  "market_comparison": "Why I agree with the 2% market odds",
  "reasoning": "..."
}
```

### New Fields

| Field | Type | Description |
|-------|------|-------------|
| `recommend_trade` | boolean | Should we trade? (primary signal) |
| `trade_direction` | 'yes' \| 'no' \| null | Which side to buy |
| `information_advantage` | 'none' \| 'weak' \| 'moderate' \| 'strong' | How much edge over crowd |
| `market_inefficiency` | string \| null | Why the market is wrong |
| `trade_thesis` | string \| null | Clear 1-sentence trade rationale |

### Implementation

**Database schema:**
```sql
ALTER TABLE evaluations ADD COLUMN recommend_trade BOOLEAN DEFAULT FALSE;
ALTER TABLE evaluations ADD COLUMN trade_direction TEXT;
ALTER TABLE evaluations ADD COLUMN information_advantage TEXT;
ALTER TABLE evaluations ADD COLUMN market_inefficiency TEXT;
ALTER TABLE evaluations ADD COLUMN trade_thesis TEXT;
```

**Types:**
```typescript
export type InformationAdvantage = 'none' | 'weak' | 'moderate' | 'strong';

export interface RichEvaluationResult {
  probability: number;
  confidence: ConfidenceLevel;
  recommend_trade: boolean;
  trade_direction: 'yes' | 'no' | null;
  information_advantage: InformationAdvantage;
  market_inefficiency: string | null;
  trade_thesis: string | null;
  // ... existing fields
}
```

**Position sizing now gated by recommend_trade:**
```typescript
let recommendedPosition = 0;
if (richEvaluation.recommend_trade && !isFloorCeilingCase) {
  recommendedPosition = calculateKellyPosition(...);
}
```

**Trade recommendations filter:**
```typescript
// Old: filter by edge threshold
const tradeRecommendations = evaluations.filter(e =>
  e.composite_edge > minEdge && ...
);

// New: filter by AI's recommend_trade decision
const tradeRecommendations = evaluations.filter(e =>
  e.recommend_trade === true && ...
);
```

### New UI Design

**Evaluated Market Card:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â¸ NO TRADE                           No Edge Info Advantage            â”‚
â”‚  Russia x Ukraine ceasefire in 2025?                                    â”‚
â”‚  polymarket â€¢ 5 minutes ago                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Market Assessment                                                      â”‚
â”‚  "Market correctly prices the low probability given Putin's..."         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Market Odds    Our Estimate    Edge       Base Rate     Position       â”‚
â”‚     2%             5%          +3.0%         ~5%            â€”           â”‚
â”‚     YES         MEDIUM conf                historical                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**When recommending trade:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ TRADE: BUY YES                    Moderate Info Advantage   [Log]   â”‚
â”‚  Will Trump talk to Xi before Jan 1?                                    â”‚
â”‚  polymarket â€¢ 12 minutes ago                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Trade Thesis                                                           â”‚
â”‚  "Breaking: WH source confirms call scheduled for Dec 28, not yet..."   â”‚
â”‚  Market inefficiency: News not widely circulated, market hasn't moved   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Market Odds    Our Estimate    Edge       Base Rate     Position       â”‚
â”‚     45%            72%        +27.0%        ~60%          2.5%          â”‚
â”‚     YES         HIGH conf     historical                   $250          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ Factors Supporting YES          âœ— Factors Supporting NO              â”‚
â”‚  â€¢ WH source confirmation          â€¢ No official announcement           â”‚
â”‚  â€¢ Pattern of December diplomacy   â€¢ Trade tensions ongoing             â”‚
â”‚  â€¢ Both leaders seeking optics     â€¢ Taiwan issue unresolved            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš  Main Uncertainty: Whether WH source is reliable                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¶ Full Reasoning                                                       â”‚
â”‚  â–¶ Research Used (2 reports)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Files Modified

| File | Changes |
|------|---------|
| `demo/agent/src/types.ts` | Added `InformationAdvantage` type, updated `RichEvaluationResult` and `Evaluation` interfaces |
| `demo/agent/schema.sql` | Added 5 new columns to evaluations table |
| `demo/agent/src/agents/analyst.ts` | New alpha-seeking prompt, parse new fields, gate position by recommend_trade |
| `demo/agent/src/scoring/evaluator.ts` | Fixed edge calculation (decimal not percentage) |
| `demo/agent/src/agents/researcher.ts` | Split into create + poll functions |
| `demo/agent/src/index.ts` | Queue consumer with resume capability |
| `demo/agent/wrangler.toml` | Added max_concurrency = 10 |
| `demo/portal/src/App.tsx` | Updated types, new evaluation card UI, filter by recommend_trade |

---

## Session 8 Summary: Philosophy Shift

### Before: Mechanical Edge Calculation
- Calculate probability
- Compare to market
- If edge > threshold, recommend trade
- **Problem:** This is just gambling with extra steps

### After: Alpha-Seeking Intelligence
- Default to NO TRADE
- Require specific information advantage
- Articulate market inefficiency
- Only trade when genuinely smarter than crowd
- **Result:** Fewer but higher-conviction recommendations

### Key Metrics Expected
- **Fewer trade recommendations** (most markets are efficient)
- **Higher conviction when trading** (only when we have alpha)
- **Better risk awareness** (extreme probabilities require extreme evidence)
- **Clearer reasoning** (must articulate the thesis)

---

## Deployed State (Dec 12)

- **Portal**: https://pundit-hq.pages.dev
- **Worker**: https://pundit-agent.gentle-disk-2e8a.workers.dev

**New Capabilities:**
- Robust Deep Research with crash recovery
- Parallel research execution
- Alpha-seeking evaluation (default NO TRADE)
- Information advantage classification
- Trade thesis articulation
- Market inefficiency identification
- Live elapsed time counter
- Fixed edge calculation and floor/ceiling handling

---

## Technical Debt / Future Work

1. **Research quality scoring** - User expressed interest in scoring research reports
2. **Selective research aggregation** - Choose which reports to include in evaluation
3. **Intermediate Deep Research progress** - Show research steps as they happen (pending Gemini API support)
4. **Evaluation prompt A/B testing** - Compare prompts in Playground
5. **WebSockets for real-time updates** - Currently polling every 5-30s, WebSockets would eliminate wasteful requests and provide instant updates. Priority: medium (cost is low but architecture is cleaner)
